<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Soundle ‚Äî Dark</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  :root{
    /* Dark Tyrian palette */
    --bg-900:#130911;
    --bg-800:#1a0f16;
    --panel:#20141d;
    --panel-2:#271924;

    --primary-600:#7b1f55; /* Tyrian gradient top */
    --primary-700:#641945; /* Tyrian gradient bottom */
    --primary-400:#d88ab7;

    --ink:#f7edf4;
    --ink-dim:#d7c4cf;
    --border:rgba(255,255,255,.14);
    --focus:#69a9ff;

    --ok-bg:#073e30; --ok-fg:#a5f5e4; --ok-br:#1a6b55;
    --bad-bg:#4a0f17; --bad-fg:#ffc8d2; --bad-br:#7a2331;

    --r-card:8px;
    --r-elm:6px;
    --shadow: 0 20px 50px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
    --blur:14px;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0; padding:0; min-height:100dvh;
    background:
      radial-gradient(900px 520px at 12% -10%, #2b0f21 0%, transparent 55%),
      radial-gradient(900px 520px at 100% 0%, #2a0e1f 0%, transparent 55%),
      linear-gradient(180deg, var(--bg-900) 0%, var(--bg-800) 100%);
    color:var(--ink);
    font-family:"Roboto", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  }
  @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  :focus-visible{ outline:3px solid var(--focus); outline-offset:2px }

  /* Header */
  header{
    position:sticky; top:0; z-index:30;
    background: linear-gradient(180deg, rgba(32,20,29,.8), rgba(32,20,29,.6));
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
  }
  .head{
    max-width:920px; margin:0 auto; padding:12px 16px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  h1{ margin:0; font-weight:900; letter-spacing:.3px; color:#fff; font-size:clamp(18px,4.2vw,22px) }
  .level-wrap{ display:flex; align-items:center; gap:8px }
  .level-pill{
    background: linear-gradient(180deg, var(--primary-600), var(--primary-700));
    color:#fff; border:1px solid rgba(255,255,255,.22);
    padding:8px 12px; font-weight:900; border-radius:var(--r-elm); box-shadow:var(--shadow);
  }
  /* Help button */
  #helpBtn{
    width:2rem;height:2rem; border-radius:999px;
    border:1px solid rgba(255,255,255,.25);
    background:transparent; color:#fff; font-weight:900; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center;
  }
  #helpBtn:hover{ background:rgba(255,255,255,.08) }

  /* Layout */
  .app{ max-width:920px; margin:16px auto 28px; padding:0 16px; display:grid; gap:12px }

  /* Cards (dark glass) */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
    border:1px solid var(--border);
    border-radius:var(--r-card);
    backdrop-filter: blur(var(--blur));
    box-shadow:var(--shadow);
    padding:14px;
  }

  /* Puzzle block */
  .stack{
    display:grid; gap:10px;
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(255,255,255,.12);
    border-radius:var(--r-card);
    padding:14px;
  }

  /* Highlighted blocks */
  .highlight{
    position:relative; padding:12px; border-radius:var(--r-elm);
    background: linear-gradient(180deg, rgba(123,31,85,.18), rgba(123,31,85,.10));
    border:1px solid rgba(255,255,255,.16);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  }
  .highlight.conclusion{
    background: linear-gradient(180deg, rgba(123,31,85,.30), rgba(123,31,85,.16));
    border-color: rgba(255,255,255,.22);
  }

  /* Chain area (selected tokens) */
  .drop-row{ display:flex; gap:10px; align-items:stretch; flex-wrap:wrap }
  .drop-slot{
    flex:1 1 320px; min-height:74px;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
    border:2px dashed rgba(216,138,183,.35);
    border-radius:var(--r-elm); padding:10px;
  }
  .slot-content{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }

  /* Tokens */
  .token{
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.28);
    color:var(--ink); border-radius:var(--r-elm);
    padding:8px 10px; font-weight:500;
    display:inline-flex; gap:8px; align-items:center;
  }
  .token .x{
    border:1px solid rgba(255,255,255,.35); background: transparent; color: var(--ink);
    border-radius:3px; padding:2px 6px; cursor:pointer; font-weight:700;
  }

  /* Premise Bank (UNLIMITED, auto-wrap) */
  .bank-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap:10px;
  }
  .chip{
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    color: var(--ink);
    border:1px solid rgba(255,255,255,.22);
    border-radius:var(--r-elm);
    padding:12px; cursor:pointer;
    text-align:left; font-weight:500;
    backdrop-filter: blur(var(--blur));
  }
  .chip:hover{ border-color: var(--primary-400) }

  /* Actions */
  .actions{ display:flex; gap:10px; flex-wrap:wrap }
  .btn{
    font-family:inherit; font-weight:900; letter-spacing:.2px;
    border-radius:var(--r-elm); padding:12px 14px; cursor:pointer;
    border:1px solid rgba(255,255,255,.25);
    background: linear-gradient(180deg, var(--primary-600), var(--primary-700));
    color:#fff; box-shadow:var(--shadow);
  }
  .btn.secondary{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
    color:var(--ink);
  }
  .btn[disabled]{opacity:.55; cursor:not-allowed}

  /* Feedback */
  .toast{
    margin-top:10px; padding:10px; border-radius:var(--r-elm); font-weight:900; border:1px solid transparent
  }
  .ok{ background:var(--ok-bg); color:var(--ok-fg); border-color:var(--ok-br) }
  .bad{ background:var(--bad-bg); color:var(--bad-fg); border-color:var(--bad-br) }

  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }

  /* ===== Modals (Tyrian purple & glassy) ===== */
  .modal{ position:fixed; inset:0; display:none; }
  .modal[aria-hidden="false"]{ display:block; }
  .modal-backdrop{
    position:absolute; inset:0; background:rgba(0,0,0,.55);
    backdrop-filter: blur(4px);
  }
  .modal-card{
    position:relative; max-width:560px; margin:10vh auto; padding:18px 18px 16px;
    border-radius:18px;
    background:
      linear-gradient(180deg, rgba(123,31,85,.38), rgba(100,25,69,.32));
    color:#fff;
    border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(16px) saturate(120%);
    box-shadow: 0 30px 80px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.08);
    animation: modalIn .18s ease-out both;
  }
  .modal-card h2{ margin:.25rem 0 .5rem 0; font-size:1.25rem; color:#fff }
  .modal-card p{ margin:.25rem 0 1rem 0; line-height:1.45; color:var(--ink-dim) }
  .modal-primary{
    padding:.7rem 1.05rem; border:1px solid rgba(255,255,255,.25); border-radius:12px; font-weight:900; cursor:pointer;
    background: linear-gradient(180deg, var(--primary-600), var(--primary-700));
    color:#fff; box-shadow:var(--shadow);
  }
  .modal-close{
    position:absolute; top:.45rem; right:.55rem; background:transparent; border:1px solid rgba(255,255,255,.28);
    color:#fff; width:32px; height:32px; border-radius:8px; cursor:pointer; font-size:1rem; line-height:1;
    display:flex; align-items:center; justify-content:center;
  }
  .modal-close:hover{ background:rgba(255,255,255,.08) }
  @keyframes modalIn{ from{ transform:translateY(6px); opacity:0 } to{ transform:none; opacity:1 } }
</style>
</head>
<body>
  <header>
    <div class="head">
      <h1>Soundle</h1>
      <div class="level-wrap">
        <div id="levelPill" class="level-pill" aria-live="polite">Level 1</div>
        <button id="helpBtn" aria-label="Help" title="Help">?</button>
      </div>
    </div>
  </header>

  <main class="app" role="application" aria-label="Soundle">
    <!-- Unified reasoning widget -->
    <section class="card stack" aria-label="Puzzle">
      <div id="basePremise" class="highlight"></div>

      <div class="drop-row">
        <div class="drop-slot" id="chainSlot" aria-label="Selected premises">
          <div class="slot-content" id="slotContent"><span class="sr-only">Empty</span></div>
        </div>
      </div>

      <div id="conclusion" class="highlight conclusion"></div>
      <div id="feedback" aria-live="polite"></div>
    </section>

    <!-- Premise Bank -->
    <section class="card" aria-label="Premise Bank">
      <div id="bankGrid" class="bank-grid" role="list"></div>
    </section>

    <!-- Actions at bottom -->
    <section class="card">
      <div class="actions">
        <button id="checkBtn" class="btn" aria-label="Check answer">Check</button>
        <button id="clearBtn" class="btn secondary" aria-label="Clear">Clear</button>
        <button id="nextBtn" class="btn" aria-label="Next level" style="display:none">Next Level</button>
      </div>
    </section>
  </main>

  <!-- ===== Help Modal ===== -->
  <div class="modal" id="help-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document">
      <button class="modal-close" data-close-modal aria-label="Close">√ó</button>
      <h2 id="help-title">How to play</h2>
      <p>Select the premises from the bank (no dragging needed). Remove a selected premise with the ‚úï. When you think the set is right, press ‚ÄúCheck‚Äù.</p>
      <button class="modal-primary" data-close-modal>Got it</button>
    </div>
  </div>

  <!-- ===== Congrats Modal ===== -->
  <div class="modal" id="congrats-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="congrats-title">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document">
      <button class="modal-close" data-close-modal aria-label="Close">√ó</button>
      <h2 id="congrats-title">All levels complete üéâ</h2>
      <p>Be sure to check out tomorrow's Soundle!</p>
      <button id="playAgainBtn" class="modal-primary">Play again</button>
    </div>
  </div>

<script>
/* ========== Levels (add unlimited options; bank auto-wraps) ========== */
const LEVELS = [
  {
    basePremise: "Human groups must secure food, shelter, and tools to live.",
    conclusion: "Therefore, large social shifts tend to follow changes in how goods are produced.",
    options: [
      "Productive forces (tools, skills, energy) tend to develop over time.",
      "Relations of production (property and control rules) are arranged to suit current productive forces.",
      "When productive forces outgrow existing relations, conflict emerges that pressures social change.",
      "Ideas alone, without any material basis, determine history.",
      "The state is always neutral toward class interests.",
      "Economic life never influences law or politics.",
      "All change is purely accidental, without pattern."
      // Add more strings here freely; no crashes.
    ],
    answerIndices: [0,1,2]
  },
  {
    basePremise: "If it rains, the streets get wet.",
    conclusion: "Therefore, there are puddles on the streets.",
    options: [
      { text: "It rained last night." },                                    // 0
      { text: "If the streets are wet, then there are puddles." },          // 1
      { text: "The streets are wet.", requires: { base: true, indices:[0] } }, // 2
      { text: "It was windy." }                                             // 3
      // Add more here‚Äîunlimited.
    ],
    answerIndices: [0,1,2]
  },
  {
    basePremise: "All A are B.",
    conclusion: "Therefore, some A are not C.",
    options: [
      "All B are D",
      "No D are C",
      "Some D are C",
      "Some A are B",
      "All C are B",
      "Some C are B",
      "All D are B",
      "All A are E"
      // Add more freely.
    ],
    answerIndices: [0,1,3]
  }
];

/* ====== State & Elements ====== */
let levelIdx = 0;
let solvedLevels = new Set();

const levelPill = document.getElementById('levelPill');
const basePremiseEl = document.getElementById('basePremise');
const conclusionEl = document.getElementById('conclusion');
const bankGrid = document.getElementById('bankGrid');
const slotContent = document.getElementById('slotContent');
const feedbackEl = document.getElementById('feedback');
const checkBtn = document.getElementById('checkBtn');
const clearBtn = document.getElementById('clearBtn');
const nextBtn = document.getElementById('nextBtn');

/* ====== Modal Elements ====== */
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('help-modal');
const congratsModal = document.getElementById('congrats-modal');
const playAgainBtn = document.getElementById('playAgainBtn');

/* ====== Helpers ====== */
const current = () => LEVELS[levelIdx];
const isObj = (o) => o && typeof o === 'object' && !Array.isArray(o);
function getOptionText(i){
  const opt = current().options[i];
  return isObj(opt) ? opt.text : String(opt);
}
function getRequires(i){
  const opt = current().options[i];
  if(isObj(opt) && opt.requires){
    const r = opt.requires;
    return { base: !!r.base, indices: Array.isArray(r.indices) ? r.indices.slice() : [] };
  }
  return { base:false, indices:[] };
}
function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function arraysSetEqual(a,b){
  if(a.length!==b.length) return false;
  const A=[...a].sort((x,y)=>x-y), B=[...b].sort((x,y)=>x-y);
  for(let i=0;i<A.length;i++) if(A[i]!==B[i]) return false;
  return true;
}

/* ===== WebAudio (success/failure + celebration) ===== */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function playTone({type='sine', freq=440, duration=0.22, gain=0.06, glideTo=null, when=0}={}){
  ensureAudio();
  const startAt = (audioCtx.currentTime + when);
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  g.gain.value = 0;
  g.gain.linearRampToValueAtTime(gain, startAt + 0.01);
  g.gain.linearRampToValueAtTime(gain*0.8, startAt + duration*0.6);
  g.gain.linearRampToValueAtTime(0.0001, startAt + duration);
  if(glideTo){
    osc.frequency.setValueAtTime(freq, startAt);
    osc.frequency.linearRampToValueAtTime(glideTo, startAt + duration);
  }
  osc.connect(g).connect(audioCtx.destination);
  osc.start(startAt);
  osc.stop(startAt + duration + 0.02);
}
function playSuccess(){
  playTone({type:'sine', freq:520, glideTo:660, duration:0.16, gain:0.06});
  playTone({type:'sine', freq:660, glideTo:880, duration:0.18, gain:0.06, when:0.11});
}
function playFail(){
  playTone({type:'sawtooth', freq:220, glideTo:140, duration:0.22, gain:0.05});
}
/* Celebratory arpeggio for "All levels complete" */
function playCelebration(){
  ensureAudio();
  const notes = [
    {f:659, d:.16}, {f:784, d:.16}, {f:988, d:.18}, // E5, G5, B5
    {f:1175, d:.18}, {f:1319, d:.22}               // D6, E6
  ];
  let t = 0;
  notes.forEach((n)=>{
    playTone({type:'triangle', freq:n.f, duration:n.d, gain:0.07, when:t});
    t += n.d * 0.75;
  });
  setTimeout(()=>{ playTone({type:'sine', freq:1760, duration:.12, gain:0.05}); }, (t*1000)|0);
}

/* ===== Order validation (only checks dependencies if you use them) ===== */
function validateOrder(order){
  for(let pos=0; pos<order.length; pos++){
    const idx = order[pos];
    const req = getRequires(idx);
    for(const need of req.indices){
      const prevPos = order.indexOf(need);
      if(prevPos === -1 || prevPos >= pos){
        return false;
      }
    }
  }
  return true;
}

/* ===== Render ===== */
function renderLevel(){
  const p = current();
  levelPill.textContent = `Level ${levelIdx+1}`;
  basePremiseEl.textContent = p.basePremise;
  conclusionEl.textContent = p.conclusion;
  feedbackEl.innerHTML = '';
  nextBtn.style.display = (solvedLevels.has(levelIdx) && levelIdx < LEVELS.length - 1) ? 'inline-block' : 'none';

  // Bank
  bankGrid.innerHTML = '';
  p.options.forEach((opt,i)=>{
    const chip = document.createElement('button');
    chip.className = 'chip'; chip.type='button';
    chip.setAttribute('role','listitem');
    chip.dataset.index = i;
    chip.textContent = getOptionText(i);
    chip.addEventListener('click', ()=> addToChain(i)); // click to select
    bankGrid.appendChild(chip);
  });

  // Chain (selected)
  slotContent.innerHTML = '<span class="sr-only">Empty</span>';
}

function addToChain(optIndex){
  // Prevent duplicates in chain
  const exists = Array.from(slotContent.querySelectorAll('[data-index]')).some(n => Number(n.dataset.index)===optIndex);
  if(exists) return;

  const sr = slotContent.querySelector('.sr-only'); if(sr) sr.remove();

  const token = document.createElement('span');
  token.className = 'token';
  token.dataset.index = String(optIndex);
  token.innerHTML = `${escapeHtml(getOptionText(optIndex))} <button class="x" aria-label="Remove">√ó</button>`;
  token.querySelector('.x').addEventListener('click', ()=>{
    token.remove();
    restoreChip(optIndex);
    if(!slotContent.querySelector('[data-index]')){
      slotContent.innerHTML = '<span class="sr-only">Empty</span>';
    }
  });
  slotContent.appendChild(token);

  // Remove the chip from the bank so it can't be selected twice
  const chip = [...bankGrid.querySelectorAll('.chip')].find(c => Number(c.dataset.index)===optIndex);
  if(chip) chip.remove();
}

function restoreChip(optIndex){
  const chip = document.createElement('button');
  chip.className = 'chip'; chip.type='button'; chip.setAttribute('role','listitem');
  chip.dataset.index = optIndex; chip.textContent = getOptionText(optIndex);
  chip.addEventListener('click', ()=> addToChain(optIndex));
  bankGrid.appendChild(chip);
}

/* ===== Modals (open/close) ===== */
function openModal(modEl){
  modEl.setAttribute('aria-hidden','false');
  const btn = modEl.querySelector('.modal-primary') || modEl.querySelector('[data-close-modal]');
  if(btn) setTimeout(()=>btn.focus(), 0);
}
function closeModal(modEl){ modEl.setAttribute('aria-hidden','true'); }
document.addEventListener('click', (e)=>{
  const closeBtn = e.target.closest('[data-close-modal]');
  if(closeBtn){ const m = closeBtn.closest('.modal'); if(m){ closeModal(m); } }
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    [helpModal, congratsModal].forEach(m=>{
      if(m.getAttribute('aria-hidden') === 'false') closeModal(m);
    });
  }
});
helpBtn.addEventListener('click', ()=>{
  ensureAudio(); // prime audio context on user gesture
  openModal(helpModal);
});

/* ===== Actions ===== */
function showToast(ok, text){
  const div = document.createElement('div');
  div.className = `toast ${ok?'ok':'bad'}`;
  div.textContent = (ok ? '‚úÖ ' : '‚ùå ') + text;
  feedbackEl.innerHTML = '';
  feedbackEl.appendChild(div);
}

checkBtn.addEventListener('click', ()=>{
  ensureAudio();

  const chosen = Array.from(slotContent.querySelectorAll('[data-index]')).map(n=>Number(n.dataset.index));
  const ans = current().answerIndices;

  const okSet = arraysSetEqual(chosen, ans);
  const okOrder = validateOrder(chosen);   // only matters if you use requires
  const ok = okSet && okOrder;

  showToast(ok, ok ? "Correct!" : "Not correct yet‚Äîtry again.");
  if(ok){
    playSuccess();
    solvedLevels.add(levelIdx);

    // Auto-final popup: celebratory sound on show
    if(levelIdx === LEVELS.length - 1){
      nextBtn.style.display = 'none';
      setTimeout(()=>{
        openModal(congratsModal);
        playCelebration();
      }, 450);
    } else {
      nextBtn.style.display = 'inline-block';
    }
  } else {
    playFail();
  }
});

clearBtn.addEventListener('click', ()=>{
  const tokens = Array.from(slotContent.querySelectorAll('[data-index]'));
  tokens.forEach(t => restoreChip(Number(t.dataset.index)));
  slotContent.innerHTML = '<span class="sr-only">Empty</span>';
  feedbackEl.innerHTML = '';
});

nextBtn.addEventListener('click', ()=>{
  if(!solvedLevels.has(levelIdx)) return;
  if(levelIdx < LEVELS.length - 1){
    levelIdx += 1;
    renderLevel();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

/* Play again resets game */
playAgainBtn.addEventListener('click', ()=>{
  closeModal(congratsModal);
  levelIdx = 0;
  solvedLevels.clear();
  renderLevel();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* ===== Init ===== */
renderLevel();
</script>
</body>
</html>
